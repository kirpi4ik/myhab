buildscript {
    repositories {
        mavenLocal()
        maven { url "https://repo.grails.org/grails/core" }
        maven { url "https://plugins.gradle.org/m2/" }
    }
    dependencies {
        classpath "org.grails:grails-gradle-plugin:$grailsVersion"
        classpath "org.grails.plugins:views-gradle:3.2.3"
        classpath "org.grails.plugins:hibernate5:$hibernateVersion"
        classpath 'org.grails.plugins:quartz:3.0.0'
    }
}
plugins {
    id "java"
    id "org.grails.plugins.views-json" version '3.2.3'
    id "codenarc"

}

// Not Published to Gradle Plugin Portal
apply plugin: "org.grails.grails-web"
apply plugin: "org.grails.grails-gsp"
java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(19)
    }
}
configurations {
    developmentOnly
    runtimeClasspath {
        extendsFrom developmentOnly
    }
}

dependencies {
    annotationProcessor "org.springframework.boot:spring-boot-configuration-processor"
    compileOnly "io.micronaut:micronaut-inject-groovy"
    profile "org.grails.profiles:vue"
    implementation project(':server-rules')
    implementation project(':server-config')

//    implementation 'io.micronaut:micronaut-core:3.4.4'
    implementation 'io.micrometer:micrometer-registry-prometheus:1.11.4'

    implementation "org.springframework.boot:spring-boot-starter-logging:"
    implementation "org.springframework.boot:spring-boot-autoconfigure"
    implementation "org.springframework.boot:spring-boot-starter-actuator"
    implementation "org.springframework.boot:spring-boot-starter-tomcat"
//    implementation "org.springframework.boot:spring-boot-starter-cache"
    implementation "org.grails:grails-core"
    implementation "org.grails:grails-plugin-url-mappings"
    implementation "org.grails:grails-plugin-rest"
    implementation "org.grails:grails-plugin-codecs"
    implementation "org.grails:grails-plugin-interceptors"
    implementation "org.grails:grails-plugin-services"
    implementation "org.grails:grails-plugin-datasource"
    implementation "org.grails:grails-plugin-databinding"
    implementation "org.grails:grails-web-boot"
    implementation "org.grails:grails-logging"
    implementation "org.grails.plugins:cache"
    implementation "org.grails.plugins:async"
    implementation "org.grails.plugins:spring-security-rest:3.0.1"
    implementation "org.grails.plugins:views-json"
    implementation "org.grails.plugins:views-json-templates"
    implementation "org.grails.plugins:events"
    implementation "org.grails.plugins:gsp"
    implementation "org.grails.plugins:hibernate5:$hibernateVersion"
    implementation "org.grails:gorm-graphql:$gormGQL"
    implementation "org.grails.plugins:gorm-graphql-plugin:$gormGQL"
    implementation "com.graphql-java:graphql-java:17.6"
    implementation "com.graphql-java:graphql-java-extended-scalars:19.1"
    implementation 'org.grails.plugins:quartz:3.0.0'
    implementation 'org.quartz-scheduler:quartz:2.4.0'
    //cache
    implementation 'com.hazelcast:hazelcast:5.3.8'
    implementation 'com.hazelcast:hazelcast-spring:5.1.1'
    implementation 'org.postgresql:postgresql:42.7.4'
    implementation 'org.grails.plugins:spring-security-rest:3.0.1'
    implementation 'org.kohsuke:groovy-sandbox:1.19'
    implementation 'org.jsoup:jsoup:1.15.3'
    implementation 'com.konghq:unirest-java:3.13.8'
    //Telegram bot api
    implementation 'org.telegram:telegrambots-spring-boot-starter:6.8.0'
//    implementation 'com.vdurmont:emoji-java:5.1.1'
    //ONVIF
    implementation 'be.teletask.onvif:onvif:1.0.2'
    //opsgenie atlassian
    implementation "com.opsgenie.integration:sdk:2+"
    //LogBack kibana integration(DO not upgrade , https://cve.report/CVE-2021-42550 removed groovy support)
    implementation 'ch.qos.logback:logback-core:1.2.3'
    implementation 'ch.qos.logback:logback-access:1.2.3'
    implementation 'ch.qos.logback:logback-classic:1.2.3'
    implementation 'net.logstash.logback:logstash-logback-encoder:6.2'
    implementation("org.apache.commons:commons-lang3:3.17.0")

    implementation 'org.grails.plugins:grails-spring-websocket:2.5.0.RC1'
    implementation "org.springframework.integration:spring-integration-mqtt"
    implementation 'org.springframework.integration:spring-integration-jmx'
    implementation 'org.eclipse.paho:org.eclipse.paho.client.mqttv3:1.2.5'

    implementation "org.springframework.security:spring-security-config"
    implementation "org.springframework.security:spring-security-messaging"
    implementation "org.springframework.security:spring-security-web"

    runtimeOnly "org.glassfish.web:el-impl:2.2.1-b05"
    runtimeOnly "org.apache.tomcat:tomcat-jdbc"
    runtimeOnly 'javax.xml.bind:jaxb-api:2.4.0-b180830.0359'

    codenarc "org.codenarc:CodeNarc:$codenarcVersion"

    console "org.grails:grails-console"
    runtimeOnly "org.grails.plugins:grails-console:2.1.1"
    testImplementation "io.micronaut:micronaut-inject-groovy"
    testImplementation "org.grails:grails-gorm-testing-support"
    testImplementation "org.mockito:mockito-core"
    testImplementation "io.micronaut:micronaut-http-client"
    testImplementation "org.grails:grails-web-testing-support:3.2.2"
    testImplementation "org.grails:views-json-testing-support:3.2.3"
    testImplementation 'org.hibernate.validator:hibernate-validator:7.0.4.Final'
}
bootRun {
    jvmArgs(
            '-Dspring.output.ansi.enabled=always',
            '-noverify',
            '-XX:TieredStopAtLevel=1',
            '-Xmx1024m'
            /*,'-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005'*/)
    sourceResources sourceSets.main
    String springProfilesActive = 'spring.profiles.active'
    systemProperty springProfilesActive, System.getProperty(springProfilesActive)
}

bootJar {
    rootSpec.filesMatching('**/*.jar', { jar ->
        String groupId = jar.file.parentFile.parentFile.parentFile.parentFile.name
        jar.name = "$groupId-${jar.name}"
    })
    archiveFileName = "${projectName}-${project.version}.jar"
}
//sourceSets {
//    main {
//        groovy {
//            srcDirs = ['grails-app/controllers',
//                       'grails-app/domain',
//                       'grails-app/init',
//                       'grails-app/jobs',
//                       'grails-app/services',
//                       'grails-app/utils']
//        }
//    }
//}
codenarc {
    toolVersion = codenarcVersion
    configFile = file("${projectDir}/config/codenarc/rules.groovy")
    maxPriority1Violations = 0
    maxPriority2Violations = 52
    maxPriority3Violations = 1600
}
codenarcMain {
    exclude '**/CustomScalars.groovy'
}

codenarcTest {
    ignoreFailures = true
}